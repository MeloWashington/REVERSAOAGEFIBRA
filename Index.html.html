<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - Ordens de Servi√ßo</title>
<!-- Libraries -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
:root {
  --primary: #FF6B35;
  --primary-light: #FF8E53;
  --primary-dark: #E55A2B;
  --secondary: #4ECDC4;
  --secondary-light: #87E5D9;
  --accent: #FFE66D;
  --dark: #2A2D34;
  --light: #F7F9FC;
  --muted: #6B7280;
  --success: #4CAF50;
  --warning: #FF9800;
  --danger: #F44336;
  --card-bg: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  --header-bg: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  --sidebar-bg: linear-gradient(180deg, var(--dark) 0%, #3A3F4B 100%);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--light);
  color: var(--dark);
  line-height: 1.6;
}

.container {
  display: grid;
  grid-template-columns: 250px 1fr;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  background: var(--sidebar-bg);
  color: white;
  padding: 20px 0;
  box-shadow: 3px 0 10px rgba(0,0,0,0.1);
}

.sidebar-header {
  padding: 0 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  margin-bottom: 20px;
}

.sidebar-header h1 {
  font-size: 1.3rem;
  font-weight: 600;
}

.sidebar-nav {
  list-style: none;
}

.sidebar-nav li {
  margin-bottom: 5px;
}

.sidebar-nav a {
  display: block;
  padding: 12px 20px;
  color: rgba(255,255,255,0.8);
  text-decoration: none;
  transition: all 0.3s;
  border-left: 3px solid transparent;
  cursor: pointer;
}

.sidebar-nav a:hover, .sidebar-nav a.active {
  background: rgba(255,255,255,0.1);
  color: white;
  border-left-color: var(--primary);
}

/* Main Content */
.main-content {
  padding: 20px;
  overflow-y: auto;
}

.header {
  background: var(--header-bg);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.header h1 {
  font-size: 1.8rem;
  margin-bottom: 10px;
}

.controls {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 20px;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.file-label {
  background: var(--primary);
  color: white;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.file-label:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

.file-name {
  color: var(--muted);
  display: flex;
  align-items: center;
}

.export-buttons {
  margin-left: auto;
  display: flex;
  gap: 10px;
}

.btn {
  padding: 10px 15px;
  border-radius: 8px;
  border: none;
  background: var(--primary);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-whatsapp { background: var(--success); }
.btn-print { background: var(--secondary); }
.btn-wpp { background: var(--success); padding: 6px 10px; font-size: 0.8rem; margin-right: 5px; }
.btn-email { background: #3498db; padding: 6px 10px; font-size: 0.8rem; }

/* Cards */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.3s;
  border-left: 4px solid var(--primary);
}

.card:hover {
  transform: translateY(-5px);
}

.card h3 {
  font-size: 0.9rem;
  color: var(--muted);
  margin-bottom: 10px;
}

.card p {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--dark);
}

.card-total { border-left-color: var(--primary); }
.card-prod { border-left-color: var(--success); }
.card-imp { border-left-color: var(--danger); }
.card-open { border-left-color: var(--warning); }

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.panel {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.panel-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.panel-header h3 {
  color: var(--dark);
  font-size: 1.2rem;
}

.panel-actions {
  display: flex;
  gap: 5px;
}

/* Tables */
.table-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.table-header h3 {
  color: var(--dark);
  font-size: 1.2rem;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.table th, .table td {
  padding: 12px 10px;
  border-bottom: 1px solid #f1f1f1;
  text-align: left;
}

.table th {
  background: rgba(0,0,0,0.02);
  color: var(--dark);
  font-weight: 600;
}

.table tbody tr:hover {
  background: rgba(0,0,0,0.02);
}

.others-row {
  background-color: #f9f9f9;
  font-weight: 600;
}

/* Filters */
.filters {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 15px;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.select, input {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
}

.small {
  font-size: 0.85rem;
  color: var(--muted);
}

.chart-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-top: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* Tabs */
.tabs {
  display: flex;
  border-bottom: 1px solid #eee;
  margin-bottom: 20px;
}

.tab {
  padding: 12px 20px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
}

.tab.active {
  border-bottom-color: var(--primary);
  color: var(--primary);
  font-weight: 600;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Responsive */
@media (max-width: 1024px) {
  .container {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: none;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .controls, .filters {
    flex-direction: column;
    align-items: stretch;
  }
  
  .export-buttons {
    margin-left: 0;
    justify-content: center;
  }
}
</style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Dashboard OS</h1>
    </div>
    <ul class="sidebar-nav">
      <li><a href="#overview" class="nav-link active" data-tab="overview">Vis√£o Geral</a></li>
      <li><a href="#supervisors" class="nav-link" data-tab="supervisors">Supervisores</a></li>
      <li><a href="#regions" class="nav-link" data-tab="regions">Regi√µes</a></li>
      <li><a href="#operators" class="nav-link" data-tab="operators">Operadores</a></li>
      <li><a href="#addresses" class="nav-link" data-tab="addresses">An√°lise de Endere√ßos</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Dashboard - Ordens de Servi√ßo</h1>
      <p>An√°lise completa e em tempo real das ordens de servi√ßo</p>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div>
        <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none">
        <label for="fileInput" class="file-label">üìä Carregar Planilha</label>
      </div>
      <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
      <div class="export-buttons">
        <button id="exportExcel" class="btn" title="Exportar para Excel">üì• Excel</button>
        <button id="exportPDF" class="btn" title="Exportar para PDF">üì• PDF</button>
      </div>
    </div>

    <!-- Cards -->
    <div class="cards-grid">
      <div class="card card-total">
        <h3>Total Geral</h3>
        <p id="totalAll">0</p>
      </div>
      <div class="card card-prod">
        <h3>Produtivas</h3>
        <p id="totalProd">0</p>
      </div>
      <div class="card card-imp">
        <h3>Improdutivas</h3>
        <p id="totalImp">0</p>
      </div>
      <div class="card card-open">
        <h3>Abertas</h3>
        <p id="totalOpen">0</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Vis√£o Geral</div>
      <div class="tab" data-tab="supervisors">Supervisores</div>
      <div class="tab" data-tab="regions">Regi√µes</div>
      <div class="tab" data-tab="operators">Operadores</div>
      <div class="tab" data-tab="addresses">Endere√ßos</div>
    </div>

    <!-- Tab Contents -->
    <div id="overview" class="tab-content active">
      <!-- Main Filters -->
      <div class="filters">
        <label class="small">Filtrar T√©cnico:</label>
        <select id="filterTechnician" class="select"><option value="__ALL__">Todos</option></select>
        <label class="small">Filtrar Turno:</label>
        <select id="filterTurn" class="select"><option value="__ALL__">Todos</option><option value="MANHA">MANH√É</option><option value="TARDE">TARDE</option></select>
        <label class="small">Mostrar somente tipo:</label>
        <select id="filterType" class="select"><option value="__ALL__">Todos</option><option value="Ativacao">Ativa√ß√µes</option><option value="Mudanca">Mudan√ßas</option><option value="Visita">Visitas</option><option value="Outros">Outros</option></select>
      </div>

      <!-- Totals Table -->
      <div class="table-container">
        <div class="table-header">
          <h3>Totais por Tipo e Turno (Ordens Ativas)</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('totalsTable', 'Totais por Tipo e Turno')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('totalsTable')">Imprimir</button>
          </div>
        </div>
        <div class="small" style="margin-bottom:15px">
          <strong>Nota:</strong> Esta tabela mostra apenas ordens ativas (abertas e improdutivas), excluindo canceladas e finalizadas.
        </div>
        <table class="table" id="totalsTable">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Total</th>
              <th>Manh√£</th>
              <th>Tarde</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Ativa√ß√µes</td>
              <td id="totalAtivacoes">0</td>
              <td id="manhaAtivacoes">0</td>
              <td id="tardeAtivacoes">0</td>
            </tr>
            <tr>
              <td>Mudan√ßas</td>
              <td id="totalMudancas">0</td>
              <td id="manhaMudancas">0</td>
              <td id="tardeMudancas">0</td>
            </tr>
            <tr>
              <td>Visitas</td>
              <td id="totalVisitas">0</td>
              <td id="manhaVisitas">0</td>
              <td id="tardeVisitas">0</td>
            </tr>
            <tr class="others-row">
              <td><strong>Outros</strong></td>
              <td id="totalOutros">0</td>
              <td id="manhaOutros">0</td>
              <td id="tardeOutros">0</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th>Total Geral</th>
              <th id="totalGeral">0</th>
              <th id="totalManha">0</th>
              <th id="totalTarde">0</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Charts and Summary -->
      <div class="dashboard-grid">
        <div class="panel">
          <div class="table-header">
            <h3>Resumo por Tipo</h3>
            <div class="panel-actions">
              <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('typeTable', 'Resumo por Tipo')">WhatsApp</button>
              <button class="btn btn-print" onclick="printTable('typeTable')">Imprimir</button>
            </div>
          </div>
          <table class="table" id="typeTable">
            <thead><tr><th>Tipo</th><th>Produtivas</th><th>Improdutivas</th><th>Total</th><th>% IMP</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th>Total</th><th id="sumProd">0</th><th id="sumImp">0</th><th id="sumTot">0</th><th id="sumPct">0%</th></tr></tfoot>
          </table>
          <div class="chart-container"><canvas id="chartByType"></canvas></div>
        </div>

        <div class="panel">
          <div class="table-header">
            <h3>Resumo por Turno</h3>
            <div class="panel-actions">
              <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('turnTable', 'Resumo por Turno')">WhatsApp</button>
              <button class="btn btn-print" onclick="printTable('turnTable')">Imprimir</button>
            </div>
          </div>
          <table class="table" id="turnTable">
            <thead><tr><th>Turno</th><th>Produtivas</th><th>Improdutivas</th><th>Abertas</th><th>Total</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th>Total</th><th id="sumTP">0</th><th id="sumTI">0</th><th id="sumTO">0</th><th id="sumTAll">0</th></tr></tfoot>
          </table>
          <div class="chart-container"><canvas id="chartByTypeTurn"></canvas></div>
        </div>
      </div>

      <!-- Improdutivo Section -->
      <div class="table-container" id="improdSection" style="display:none">
        <div class="table-header">
          <h3>Ordens IMPRODUTIVAS</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('improdTable', 'Ordens Improdutivas')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('improdTable')">Imprimir</button>
          </div>
        </div>
        <div class="small" style="margin-bottom:15px">Filtro por t√©cnico/tipo/problema abaixo atua sobre esta tabela.</div>
        <div class="filters">
          <select id="filterImprodTecnico" class="select"><option value="__ALL__">Todos os t√©cnicos</option></select>
          <select id="filterImprodTipo" class="select"><option value="__ALL__">Todos os tipos</option></select>
          <select id="filterImprodProblema" class="select"><option value="__ALL__">Todos os problemas</option></select>
          <select id="filterImprodSupervisor" class="select"><option value="__ALL__">Todos supervisores</option></select>
          <select id="filterImprodRegiao" class="select"><option value="__ALL__">Todas regi√µes</option></select>
          <select id="filterImprodOperador" class="select"><option value="__ALL__">Todos operadores</option></select>
        </div>
        <table class="table" id="improdTable">
          <thead>
            <tr>
              <th>Protocolo</th>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Problema</th>
              <th>T√©cnico</th>
              <th>Data Agenda</th>
              <th>Turno</th>
              <th>Supervisor</th>
              <th>Regi√£o</th>
              <th>Operador</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Abertas Section -->
      <div class="table-container" id="openSection" style="display:none">
        <div class="table-header">
          <h3>Ordens ABERTAS</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('openTable', 'Ordens Abertas')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('openTable')">Imprimir</button>
          </div>
        </div>
        <div class="small" style="margin-bottom:15px">
          <strong>Status considerados abertos:</strong> ABERTA, NAO DEFINIDO, NAO ATRIBUIDA, EM ATENDIMENTO, AGUARDANDO ATENDIMENTO, EM DESLOCAMENTO, PENDENTE, AGENDADA, PROGRAMADA
        </div>
        <div class="filters">
          <select id="filterOpenTecnico" class="select"><option value="__ALL__">Todos os t√©cnicos</option></select>
          <select id="filterOpenTipo" class="select"><option value="__ALL__">Todos os tipos</option></select>
          <select id="filterOpenSituacao" class="select"><option value="__ALL__">Todas situa√ß√µes</option></select>
          <select id="filterOpenSupervisor" class="select"><option value="__ALL__">Todos supervisores</option></select>
          <select id="filterOpenRegiao" class="select"><option value="__ALL__">Todas regi√µes</option></select>
          <select id="filterOpenOperador" class="select"><option value="__ALL__">Todos operadores</option></select>
        </div>
        <table class="table" id="openTable">
          <thead>
            <tr>
              <th>Protocolo</th>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Situa√ß√£o</th>
              <th>Status</th>
              <th>Problema</th>
              <th>T√©cnico</th>
              <th>Data Agenda</th>
              <th>Turno</th>
              <th>Supervisor</th>
              <th>Regi√£o</th>
              <th>Operador</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Supervisors Tab -->
    <div id="supervisors" class="tab-content">
      <div class="table-container">
        <div class="table-header">
          <h3>Resumo por Supervisor</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('supervisorTable', 'Resumo por Supervisor')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('supervisorTable')">Imprimir</button>
          </div>
        </div>
        <table class="table" id="supervisorTable">
          <thead>
            <tr>
              <th>Supervisor</th>
              <th>Total</th>
              <th>Produtivas</th>
              <th>Improdutivas</th>
              <th>Abertas</th>
              <th>% Produtivo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Regions Tab -->
    <div id="regions" class="tab-content">
      <div class="table-container">
        <div class="table-header">
          <h3>Resumo por Regi√£o</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('regiaoTable', 'Resumo por Regi√£o')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('regiaoTable')">Imprimir</button>
          </div>
        </div>
        <table class="table" id="regiaoTable">
          <thead>
            <tr>
              <th>Regi√£o</th>
              <th>Total</th>
              <th>Produtivas</th>
              <th>Improdutivas</th>
              <th>Abertas</th>
              <th>% Produtivo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Operators Tab -->
    <div id="operators" class="tab-content">
      <div class="table-container">
        <div class="table-header">
          <h3>Resumo por Operador</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('operadorTable', 'Resumo por Operador')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('operadorTable')">Imprimir</button>
          </div>
        </div>
        <table class="table" id="operadorTable">
          <thead>
            <tr>
              <th>Operador</th>
              <th>Total</th>
              <th>Produtivas</th>
              <th>Improdutivas</th>
              <th>Abertas</th>
              <th>% Produtivo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Address Analysis Tab -->
    <div id="addresses" class="tab-content">
      <div class="table-container">
        <div class="table-header">
          <h3>An√°lise de Endere√ßos Repetidos</h3>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="shareTableByWhatsApp('addressAnalysisTable', 'Endere√ßos Repetidos')">WhatsApp</button>
            <button class="btn btn-print" onclick="printTable('addressAnalysisTable')">Imprimir</button>
          </div>
        </div>
        <div class="small" style="margin-bottom:15px">
          <strong>Nota:</strong> Esta an√°lise mostra endere√ßos que aparecem m√∫ltiplas vezes na base de dados.
        </div>
        <table class="table" id="addressAnalysisTable">
          <thead>
            <tr>
              <th>Endere√ßo</th>
              <th>Quantidade</th>
              <th>Protocolos</th>
              <th>Clientes</th>
              <th>T√©cnicos</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="updateInfo" class="small" style="margin-top:20px; text-align: center; padding: 15px; background: white; border-radius: 8px;"></div>
  </div>
</div>

<script>
// Helper utils
function norm(v){ if(v===undefined||v===null) return ''; try{return String(v).normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toUpperCase()}catch(e){return String(v).toUpperCase().trim()} }
function excelDateToStr(v){ if(typeof v==='number'&&v>20000){ const d=new Date(Math.round((v-25569)*86400*1000)); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear(); } return v }

// Column fallback map (0-based indexes)
const FALLBACK = { 
  protocolo:2, 
  cliente:3, 
  tipo:8, 
  situacao:9, 
  statusK:10, 
  problema:11, 
  tecnico:13, 
  dt_agenda:14, 
  turno:18,
  rua: 6,
  supervisor: 25,
  regiao: 26,  
  operador: 27
};

function detectMap(headerRow){ 
  const h = (headerRow||[]).map(x=>norm(x||'')); 
  const find=(keys)=>{ 
    for(let i=0;i<h.length;i++){ 
      for(const k of keys){ 
        if(h[i].includes(k)) return i; 
      } 
    } 
    return -1 
  };
  
  const map = { 
    protocolo:find(['PROTOC','NUM_OS','OS','PROT']),
    tipo:find(['TIPO','TIPO_SOLICIT']),
    situacao:find(['SITUACAO','SITUA']),
    statusK:find(['STATUS']),
    problema:find(['PROBLEMA']),
    tecnico:find(['TECNICO']),
    dt_agenda:find(['DT_AGEND','DT_AGENDA','DATA AGEND']),
    turno:find(['TURNO']),
    rua:find(['RUA','ENDERECO','LOGRADOURO']),
    supervisor:find(['SUPERVISOR']),
    regiao:find(['REGIAO']),
    operador:find(['OPERADOR','COP RESPONSAVEL','RESPONSAVEL']),
    cliente_candidates:[]
  };
  
  for(let i=0;i<h.length;i++){ 
    if(h[i].includes('CLIENTE')||h[i].includes('NOME')||h[i].includes('RAZAO')) 
      map.cliente_candidates.push(i); 
  }
  
  Object.keys(FALLBACK).forEach(k=>{ 
    if(map[k]===undefined||map[k]===-1||(Array.isArray(map[k])&&map[k].length===0)) 
      map[k]=FALLBACK[k]; 
  }); 
  
  if(!Array.isArray(map.cliente_candidates)) map.cliente_candidates=[map.cliente_candidates]; 
  return map; 
}

function pickClientCol(rows,cands){ function hasLetters(s){ return /[A-Za-z√Ä-√ø]/.test(String(s||'')); } for(const c of cands){ for(let i=0;i<Math.min(10,rows.length);i++){ if(hasLetters(rows[i][c])) return c; } } return cands[0] }

// Main
let RAW_ROWS = [];
let OBJECTS = [];
let CURRENT = { technician:'__ALL__', turn:'__ALL__', type:'__ALL__' };
let charts = { byType:null, byTypeTurn:null };

// Tab navigation function
function switchTab(tabName) {
  // Remove active class from all tabs and contents
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  
  // Add active class to selected tab and content
  document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(tabName).classList.add('active');
  document.querySelector(`.nav-link[data-tab="${tabName}"]`).classList.add('active');
}

// Initialize navigation
document.addEventListener('DOMContentLoaded', function() {
  // Tab click handlers
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      switchTab(tabName);
    });
  });
  
  // Sidebar navigation click handlers
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const tabName = this.getAttribute('data-tab');
      switchTab(tabName);
    });
  });
});

document.getElementById('fileInput').addEventListener('change', async function(e){ 
  const f = e.target.files[0]; 
  if(!f) return; 
  document.getElementById('fileName').textContent = f.name; 
  const data = await f.arrayBuffer(); 
  const wb = XLSX.read(data,{type:'array'}); 
  const ws = wb.Sheets[wb.SheetNames[0]]; 
  const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:''}); 
  const header = rows[0]; 
  const hasHeader = header.some(c=>typeof c==='string'&&c.trim()&&/[A-Za-z]/.test(c)); 
  const dataRows = hasHeader?rows.slice(1):rows; 
  const map = detectMap(header); 
  map.cliente = pickClientCol(dataRows,map.cliente_candidates);
  RAW_ROWS = dataRows; 
  buildObjects(RAW_ROWS,map); 
  renderAll(); 
});

function buildObjects(rows,map){ 
  OBJECTS = []; 
  for(const r of rows){ 
    const cell=(i)=> (r && r[i]!==undefined && r[i]!==null)?r[i]:''; 
    const protocolo = cell(map.protocolo); 
    const cliente = cell(map.cliente); 
    const tipo = cell(map.tipo); 
    const situacao = cell(map.situacao); 
    const statusK = cell(map.statusK); 
    const problema = cell(map.problema); 
    const tecnico = cell(map.tecnico); 
    const dt_ag = cell(map.dt_agenda); 
    const dt_agenda = (typeof dt_ag==='number')?excelDateToStr(dt_ag):dt_ag; 
    const turno = cell(map.turno);
    const rua = cell(map.rua);
    const supervisor = cell(map.supervisor);
    const regiao = cell(map.regiao);
    const operador = cell(map.operador);
    
    OBJECTS.push({
      protocolo,
      cliente,
      tipo,
      situacao,
      statusK,
      problema,
      tecnico,
      dt_agenda,
      turno,
      rua,
      supervisor,
      regiao,
      operador
    }); 
  } 
}

function computeFiltered(){ 
  return OBJECTS.filter(o=>{
    if(CURRENT.technician!=='__ALL__' && String(o.tecnico||'').toUpperCase()!==String(CURRENT.technician||'').toUpperCase()) return false;
    if(CURRENT.turn!=='__ALL__' && String((o.turno||'').toUpperCase())!==String(CURRENT.turn||'').toUpperCase()) return false;
    if(CURRENT.type!=='__ALL__'){
      const t=norm(o.tipo||'');
      if(CURRENT.type==='Ativacao' && !t.includes('ATIV')) return false; 
      if(CURRENT.type==='Mudanca' && !t.includes('MUDAN')) return false; 
      if(CURRENT.type==='Visita' && !(t.includes('VISIT')||t.includes('REPARO'))) return false;
      if(CURRENT.type==='Outros') {
        const isAtiv = t.includes('ATIV');
        const isMud = t.includes('MUDAN');
        const isVisit = t.includes('VISIT') || t.includes('REPARO');
        if (isAtiv || isMud || isVisit) return false;
      }
    }
    return true; 
  }); 
}

function renderAll(){ 
  const rows = computeFiltered(); 
  
  // Classification sets
  const productiveSet = new Set(['FINALIZADA','PRODUTIVA','FECHADA','FECHAMENTO','CONCLUIDA','REALIZADA']);
  const improdSet = new Set(['IMPRODUTIVO','IMPRODUTIVA','N√ÉO REALIZADA','NAO REALIZADA']);
  const cancelSet = new Set(['CANCELADO','CANCELAMENTO','CANCELADA']);
  const explicitOpen = new Set(['ABERTA','NAO DEFINIDO','NAO ATRIBUIDA','EM ATENDIMENTO','AGUARDANDO ATENDIMENTO','EM DESLOCAMENTO','PENDENTE','AGENDADA','PROGRAMADA']);
  
  // Counters
  const totalsByType={Ativacao:0,Mudanca:0,Visita:0,Outros:0}; 
  const produtivasByType={Ativacao:0,Mudanca:0,Visita:0,Outros:0}; 
  const improdutivasByType={Ativacao:0,Mudanca:0,Visita:0,Outros:0}; 
  const turnTotals={},turnProd={},turnImp={},turnOpen={}; 
  const improdRows=[], openRows=[]; 
  const dates=new Set();
  
  // New counters for supervisor, region, operator
  const supervisorSummary = {};
  const regiaoSummary = {};
  const operadorSummary = {};
  
  // Counters for type and shift
  const totalsByTypeAndShift = {
    Ativacao: { total: 0, manha: 0, tarde: 0 },
    Mudanca: { total: 0, manha: 0, tarde: 0 },
    Visita: { total: 0, manha: 0, tarde: 0 },
    Outros: { total: 0, manha: 0, tarde: 0 }
  };
  
  rows.forEach(o=>{ 
    const tipoN=norm(o.tipo||''); 
    const situ=norm(o.situacao||''); 
    const statusN=norm(o.statusK||''); 
    const prob=norm(o.problema||''); 
    const tecnico=o.tecnico||''; 
    const turno=(o.turno||'').toString().trim()||'SEM TURNO'; 
    const dt=o.dt_agenda||''; 
    const supervisor = o.supervisor || 'N√ÉO INFORMADO';
    const regiao = o.regiao || 'N√ÉO INFORMADO';
    const operador = o.operador || 'N√ÉO INFORMADO';
    
    if(dt) dates.add(dt);
    
    let tipoKey='Outros'; 
    if(tipoN.includes('ATIV')) tipoKey='Ativacao'; 
    else if(tipoN.includes('MUDAN')) tipoKey='Mudanca'; 
    else if(tipoN.includes('VISIT')||tipoN.includes('REPAR')) tipoKey='Visita'; 
    
    const effective = (statusN || situ).toUpperCase().trim();
    const isProd=productiveSet.has(effective); 
    const isImp=improdSet.has(effective); 
    const isCancel=cancelSet.has(effective); 
    const isOpen = explicitOpen.has(effective) && !isProd && !isImp && !isCancel;

    // Update supervisor summary
    if(!supervisorSummary[supervisor]) {
      supervisorSummary[supervisor] = { total: 0, prod: 0, imp: 0, open: 0 };
    }
    supervisorSummary[supervisor].total++;
    if(isProd) supervisorSummary[supervisor].prod++;
    if(isImp) supervisorSummary[supervisor].imp++;
    if(isOpen) supervisorSummary[supervisor].open++;
    
    // Update region summary
    if(!regiaoSummary[regiao]) {
      regiaoSummary[regiao] = { total: 0, prod: 0, imp: 0, open: 0 };
    }
    regiaoSummary[regiao].total++;
    if(isProd) regiaoSummary[regiao].prod++;
    if(isImp) regiaoSummary[regiao].imp++;
    if(isOpen) regiaoSummary[regiao].open++;
    
    // Update operator summary
    if(!operadorSummary[operador]) {
      operadorSummary[operador] = { total: 0, prod: 0, imp: 0, open: 0 };
    }
    operadorSummary[operador].total++;
    if(isProd) operadorSummary[operador].prod++;
    if(isImp) operadorSummary[operador].imp++;
    if(isOpen) operadorSummary[operador].open++;
    
    // Counters for active orders by type and shift
    if ((isOpen || isImp) && !isProd && !isCancel) {
      totalsByTypeAndShift[tipoKey].total++;
      if (norm(turno).includes('MANHA')) {
        totalsByTypeAndShift[tipoKey].manha++;
      } else if (norm(turno).includes('TARDE')) {
        totalsByTypeAndShift[tipoKey].tarde++;
      }
    }
    
    // Other counters
    if(!isCancel) totalsByType[tipoKey]++; 
    if(isProd) produtivasByType[tipoKey]++; 
    if(isImp) improdutivasByType[tipoKey]++; 
    
    if (!isCancel) {
      turnTotals[turno]=(turnTotals[turno]||0)+1; 
    }
    
    if(isProd) turnProd[turno]=(turnProd[turno]||0)+1; 
    else if(isImp) turnImp[turno]=(turnImp[turno]||0)+1; 
    else if(isOpen) turnOpen[turno]=(turnOpen[turno]||0)+1;
    
    if(isImp) improdRows.push(o);
    if(isOpen) openRows.push(o);
  });
  
  // Update totals by type and shift table
  document.getElementById('totalAtivacoes').textContent = totalsByTypeAndShift.Ativacao.total;
  document.getElementById('manhaAtivacoes').textContent = totalsByTypeAndShift.Ativacao.manha;
  document.getElementById('tardeAtivacoes').textContent = totalsByTypeAndShift.Ativacao.tarde;
  
  document.getElementById('totalMudancas').textContent = totalsByTypeAndShift.Mudanca.total;
  document.getElementById('manhaMudancas').textContent = totalsByTypeAndShift.Mudanca.manha;
  document.getElementById('tardeMudancas').textContent = totalsByTypeAndShift.Mudanca.tarde;
  
  document.getElementById('totalVisitas').textContent = totalsByTypeAndShift.Visita.total;
  document.getElementById('manhaVisitas').textContent = totalsByTypeAndShift.Visita.manha;
  document.getElementById('tardeVisitas').textContent = totalsByTypeAndShift.Visita.tarde;
  
  document.getElementById('totalOutros').textContent = totalsByTypeAndShift.Outros.total;
  document.getElementById('manhaOutros').textContent = totalsByTypeAndShift.Outros.manha;
  document.getElementById('tardeOutros').textContent = totalsByTypeAndShift.Outros.tarde;
  
  const totalGeral = totalsByTypeAndShift.Ativacao.total + totalsByTypeAndShift.Mudanca.total + 
                    totalsByTypeAndShift.Visita.total + totalsByTypeAndShift.Outros.total;
  const totalManha = totalsByTypeAndShift.Ativacao.manha + totalsByTypeAndShift.Mudanca.manha + 
                    totalsByTypeAndShift.Visita.manha + totalsByTypeAndShift.Outros.manha;
  const totalTarde = totalsByTypeAndShift.Ativacao.tarde + totalsByTypeAndShift.Mudanca.tarde + 
                    totalsByTypeAndShift.Visita.tarde + totalsByTypeAndShift.Outros.tarde;
  
  document.getElementById('totalGeral').textContent = totalGeral;
  document.getElementById('totalManha').textContent = totalManha;
  document.getElementById('totalTarde').textContent = totalTarde;
  
  // Update main totals
  const totalProd = Object.values(produtivasByType).reduce((a,b)=>a+b,0); 
  const totalImp = Object.values(improdutivasByType).reduce((a,b)=>a+b,0); 
  const totalOpen = openRows.length; 
  const totalAll=totalProd+totalImp+totalOpen;
  
  document.getElementById('totalProd').textContent=totalProd; 
  document.getElementById('totalImp').textContent=totalImp; 
  document.getElementById('totalOpen').textContent=totalOpen; 
  document.getElementById('totalAll').textContent=totalAll;
  
  // Render supervisor summary
  renderSummaryTable('supervisorTable', supervisorSummary);
  
  // Render region summary
  renderSummaryTable('regiaoTable', regiaoSummary);
  
  // Render operator summary
  renderSummaryTable('operadorTable', operadorSummary);
  
  // Render address analysis
  renderAddressAnalysis(rows);
  
  // Render type table
  const tbodyType=document.querySelector('#typeTable tbody'); 
  tbodyType.innerHTML=''; 
  let sumP=0,sumI=0,sumT=0; 
  ['Ativacao','Mudanca','Visita','Outros'].forEach(k=>{ 
    const p=produtivasByType[k]||0; 
    const i=improdutivasByType[k]||0; 
    const t=totalsByType[k]||0; 
    sumP+=p; 
    sumI+=i; 
    sumT+=t; 
    const pct = (p+i)===0? '0%': ((i/(p+i))*100).toFixed(1)+'%'; 
    const label = k==='Ativacao'?'Ativa√ß√µes':k==='Mudanca'?'Mudan√ßas':k==='Visita'?'Visitas':'Outros'; 
    const rowClass = k === 'Outros' ? 'class="others-row"' : '';
    tbodyType.innerHTML+=`<tr ${rowClass}><td>${label}</td><td>${p}</td><td>${i}</td><td>${t}</td><td>${pct}</td></tr>` 
  }); 
  document.getElementById('sumProd').textContent=sumP; 
  document.getElementById('sumImp').textContent=sumI; 
  document.getElementById('sumTot').textContent=sumT; 
  document.getElementById('sumPct').textContent = (sumP+sumI)===0? '0%': ((sumI/(sumP+sumI))*100).toFixed(1)+'%';
  
  // Render turn table
  const tbodyTurn=document.querySelector('#turnTable tbody'); 
  tbodyTurn.innerHTML=''; 
  let sTP=0,sTI=0,sTO=0,sTAll=0; 
  Object.keys(turnTotals).forEach(t=>{ 
    const p=turnProd[t]||0; 
    const i=turnImp[t]||0; 
    const o=turnOpen[t]||0; 
    const tot=turnTotals[t]||0; 
    sTP+=p; 
    sTI+=i; 
    sTO+=o; 
    sTAll+=tot; 
    tbodyTurn.innerHTML+=`<tr><td>${t}</td><td>${p}</td><td>${i}</td><td>${o}</td><td>${tot}</td></tr>` 
  }); 
  document.getElementById('sumTP').textContent=sTP; 
  document.getElementById('sumTI').textContent=sTI; 
  document.getElementById('sumTO').textContent=sTO; 
  document.getElementById('sumTAll').textContent=sTAll;
  
  // Render improdutivo table
  renderDetailTable('improdTable', improdRows, 'improdSection');
  
  // Render open table
  renderDetailTable('openTable', openRows, 'openSection');
  
  // Update filters
  updateFilters();
  
  // Render charts
  renderCharts(totalsByType, produtivasByType, improdutivasByType, turnTotals, turnProd, turnImp);
  
  document.getElementById('updateInfo').innerText = `√öltima atualiza√ß√£o: ${new Date().toLocaleString()} ‚Ä¢ ${rows.length} ordens processadas`;
}

function renderSummaryTable(tableId, summaryData) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  
  Object.keys(summaryData).forEach(key => {
    const data = summaryData[key];
    const prodPct = data.total > 0 ? ((data.prod / data.total) * 100).toFixed(1) + '%' : '0%';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${key}</td>
      <td>${data.total}</td>
      <td>${data.prod}</td>
      <td>${data.imp}</td>
      <td>${data.open}</td>
      <td>${prodPct}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderAddressAnalysis(rows) {
  const addressMap = {};
  
  // Group by address
  rows.forEach(o => {
    const address = norm(o.rua || '');
    if (!addressMap[address]) {
      addressMap[address] = [];
    }
    addressMap[address].push(o);
  });
  
  // Filter addresses that appear multiple times
  const repeatedAddresses = Object.keys(addressMap).filter(address => 
    addressMap[address].length > 1 && address !== '' && address !== 'N√ÉO INFORMADO'
  );
  
  const tbody = document.querySelector('#addressAnalysisTable tbody');
  tbody.innerHTML = '';
  
  repeatedAddresses.forEach(address => {
    const orders = addressMap[address];
    const protocols = orders.map(o => o.protocolo).join(', ');
    const clients = orders.map(o => o.cliente).slice(0, 3).join(', ');
    const technicians = [...new Set(orders.map(o => o.tecnico))].join(', ');
    const statuses = [...new Set(orders.map(o => o.situacao))].join(', ');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${address}</td>
      <td>${orders.length}</td>
      <td>${protocols}</td>
      <td>${clients}</td>
      <td>${technicians}</td>
      <td>${statuses}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderDetailTable(tableId, rows, sectionId) {
  const section = document.getElementById(sectionId);
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';

  if (rows.length === 0) {
    section.style.display = 'none';
  } else {
    section.style.display = 'block';
    
    rows.forEach(r => {
      const w = encodeURIComponent(`Cliente:${r.cliente}\nProtocolo:${r.protocolo}\nTipo:${r.tipo}\nSitua√ß√£o:${r.situacao}\nStatus:${r.statusK}\nProblema:${r.problema}\nT√©cnico:${r.tecnico}\nData:${r.dt_agenda}\nTurno:${r.turno}\nSupervisor:${r.supervisor}\nRegi√£o:${r.regiao}\nOperador:${r.operador}`);
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.protocolo}</td>
        <td>${r.cliente}</td>
        <td>${r.tipo}</td>
        <td>${tableId === 'openTable' ? r.situacao : r.problema}</td>
        ${tableId === 'openTable' ? `<td>${r.statusK || '-'}</td><td>${r.problema}</td>` : ''}
        <td>${r.tecnico || '-'}</td>
        <td>${r.dt_agenda || '-'}</td>
        <td>${r.turno || '-'}</td>
        <td>${r.supervisor || '-'}</td>
        <td>${r.regiao || '-'}</td>
        <td>${r.operador || '-'}</td>
        <td>
          <button class='btn btn-wpp' onclick="window.open('https://api.whatsapp.com/send?text=${w}','_blank')">WhatsApp</button>
          <button class='btn btn-email' onclick="window.location.href='mailto:?subject=Ordem ${tableId === 'openTable' ? 'ABERTA' : 'IMPRODUTIVO'} ${encodeURIComponent(r.protocolo || '')}&body=${w}'">E-mail</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
}

function updateFilters() {
  const techTop = document.getElementById('filterTechnician'); 
  techTop.innerHTML='<option value="__ALL__">Todos</option>'; 
  const techs = Array.from(new Set(OBJECTS.map(o=>o.tecnico||'').filter(x=>x))).sort(); 
  techs.forEach(t=>techTop.appendChild(new Option(t,t)));
  
  const turnTop = document.getElementById('filterTurn'); 
  turnTop.innerHTML='<option value="__ALL__">Todos</option>'; 
  const turns = Array.from(new Set(OBJECTS.map(o=> (o.turno||'').toString().trim()||'SEM TURNO'))).sort(); 
  turns.forEach(t=>turnTop.appendChild(new Option(t,t)));
}

function renderCharts(totalsByType, prodByType, impByType, turnTotals, turnProd, turnImp) {
  if (Chart.registry.getPlugin('datalabels') === undefined) {
    Chart.register(ChartDataLabels);
  }

  // Chart by type
  const ctx = document.getElementById('chartByType').getContext('2d');
  const labels = ['Ativa√ß√µes', 'Mudan√ßas', 'Visitas', 'Outros'];
  const prodData = [prodByType.Ativacao || 0, prodByType.Mudanca || 0, prodByType.Visita || 0, prodByType.Outros || 0];
  const impData = [impByType.Ativacao || 0, impByType.Mudanca || 0, impByType.Visita || 0, impByType.Outros || 0];
  
  if (charts.byType) charts.byType.destroy();
  
  charts.byType = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Produtivas',
          data: prodData,
          backgroundColor: '#4CAF50',
          borderColor: '#388E3C',
          borderWidth: 1
        },
        {
          label: 'Improdutivas',
          data: impData,
          backgroundColor: '#F44336',
          borderColor: '#D32F2F',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 12 },
          formatter: function(value, context) {
            return value > 0 ? value : '';
          }
        }
      },
      scales: {
        x: {
          grid: { display: false }
        },
        y: {
          grid: { display: false },
          beginAtZero: true
        }
      }
    }
  });

  // Chart by turn
  const ctx2 = document.getElementById('chartByTypeTurn').getContext('2d');
  const turnLabels = Object.keys(turnTotals);
  const datasetProd = turnLabels.map(t => turnProd[t] || 0);
  const datasetImp = turnLabels.map(t => turnImp[t] || 0);
  
  if (charts.byTypeTurn) charts.byTypeTurn.destroy();
  
  charts.byTypeTurn = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: turnLabels,
      datasets: [
        {
          label: 'Produtivas',
          data: datasetProd,
          backgroundColor: '#4CAF50',
          borderColor: '#388E3C',
          borderWidth: 1
        },
        {
          label: 'Improdutivas',
          data: datasetImp,
          backgroundColor: '#F44336',
          borderColor: '#D32F2F',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 12 },
          formatter: function(value, context) {
            return value > 0 ? value : '';
          }
        }
      },
      scales: {
        x: {
          stacked: false,
          grid: { display: false }
        },
        y: {
          stacked: false,
          beginAtZero: true,
          grid: { display: false }
        }
      }
    }
  });
}

// Export functions
document.getElementById('exportExcel').addEventListener('click', function(){
  const wb = XLSX.utils.book_new();
  
  // Add all summary tables
  const tables = ['typeTable', 'turnTable', 'totalsTable', 'supervisorTable', 'regiaoTable', 'operadorTable', 'addressAnalysisTable'];
  tables.forEach(tableId => {
    const table = document.getElementById(tableId);
    const arr = [];
    const ths = Array.from(table.querySelectorAll('thead th')).map(t=>t.innerText);
    arr.push(ths);
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr=> arr.push(Array.from(tr.children).map(td=>td.innerText)));
    const ws = XLSX.utils.aoa_to_sheet(arr);
    XLSX.utils.book_append_sheet(wb, ws, tableId.replace('Table', ''));
  });
  
  XLSX.writeFile(wb, 'resumo_ordens_completo.xlsx');
});

document.getElementById('exportPDF').addEventListener('click', async function(){ 
  const { jsPDF } = window.jspdf; 
  const doc = new jsPDF('p','pt','a4'); 
  doc.setFontSize(16); 
  doc.text('Resumo de Ordens - Relat√≥rio', 40, 40); 
  doc.setFontSize(10); 
  doc.text(document.getElementById('updateInfo').innerText || '', 40, 60);
  doc.save('resumo_ordens.pdf'); 
});

// WhatsApp sharing function
function shareTableByWhatsApp(tableId, tableName) {
  const table = document.getElementById(tableId);
  const rows = Array.from(table.querySelectorAll('tr'));
  let message = `*${tableName}*\n\n`;
  
  rows.forEach(row => {
    const cells = Array.from(row.querySelectorAll('th, td'));
    const rowText = cells.map(cell => cell.innerText).join(' | ');
    message += rowText + '\n';
  });
  
  message += `\nRelat√≥rio gerado em: ${new Date().toLocaleString()}`;
  
  const encodedMessage = encodeURIComponent(message);
  window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
}

// Print table function
function printTable(tableId) {
  const table = document.getElementById(tableId);
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>Imprimir ${tableId}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .others-row { background-color: #f9f9f9; font-weight: 600; }
        </style>
      </head>
      <body>
        <h2>${document.querySelector(`#${tableId}`).closest('.table-container').querySelector('h3').innerText}</h2>
        ${table.outerHTML}
        <p>Relat√≥rio gerado em: ${new Date().toLocaleString()}</p>
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}
</script>
</body>
</html>