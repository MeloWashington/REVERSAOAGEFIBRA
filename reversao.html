<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suporte Técnico - Gerenciamento de Quebras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #14b8a6;
            --secondary: #0e7490;
            --light: #f0fdfa;
            --dark: #042f2e;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f0fdfa 0%, #d1fae5 100%);
            min-height: 100vh;
            padding: 20px;
            color: #042f2e;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(15, 118, 110, 0.3);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            background: white;
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-icon i {
            color: var(--primary);
            font-size: 28px;
        }
        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
        }
        .logo-text p {
            font-size: 14px;
            opacity: 0.9;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-icon {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-icon i {
            font-size: 22px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(20, 184, 166, 0.1);
            color: var(--primary);
            font-size: 24px;
        }
        .stat-content h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 5px;
        }
        .stat-content p {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        .card-header i {
            color: var(--primary);
            font-size: 22px;
        }
        .card-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        .form-group label span {
            color: var(--danger);
        }
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .radio-item input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .success-message {
            background: linear-gradient(90deg, var(--success) 0%, #4ade80 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(15, 118, 110, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(90deg, var(--accent) 0%, #a78bfa 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
        }
        .btn-warning {
            background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }
        .btn-danger {
            background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        .info-card {
            background: #f0fdfa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        .info-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            color: var(--dark);
        }
        .info-card ul {
            padding-left: 20px;
        }
        .info-card li {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.5;
        }
        .submission-item {
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
        }
        .submission-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .submission-id {
            font-weight: 700;
            color: var(--dark);
        }
        .submission-date {
            font-size: 14px;
            color: #64748b;
        }
        .submission-details {
            font-size: 14px;
            color: #475569;
            line-height: 1.5;
        }
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        .chart-box {
            height: 350px;
            position: relative;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
            margin-top: 30px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-message-box {
            background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .info-message-box {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-container input {
            flex: 1;
        }
        .delete-btn {
            position: absolute;
            top: 15px;
            right: 10px;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        .delete-btn:hover {
            color: #dc2626;
        }
        .no-results {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }
        .config-panel {
            background: #f0fdfa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        .config-panel h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--dark);
        }
        .config-group {
            margin-bottom: 15px;
        }
        .config-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .config-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        .guide-container {
            background: #f0fdfa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--success);
        }
        .guide-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--dark);
        }
        .guide-steps {
            padding-left: 20px;
        }
        .guide-steps li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .guide-steps strong {
            color: var(--primary);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Suporte Técnico</h1>
                        <p>Gerenciamento de Quebras</p>
                    </div>
                </div>
                <div class="user-info">
                    <div>
                        <p>Operador: <strong>Múltiplos Operadores</strong></p>
                        <p>Último acesso: <span id="last-access">23/07/2025, 13:57</span></p>
                    </div>
                    <div class="user-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p id="loading-text">Conectando com a planilha...</p>
        </div>
        
        <div id="content">
            <div class="error-message-box" id="error-message">
                <i class="fas fa-exclamation-triangle"></i> <span id="error-text"></span>
            </div>
            
            <div class="info-message-box" id="info-message">
                <i class="fas fa-info-circle"></i> <span id="info-text"></span>
            </div>
            
            <div class="config-panel">
                <h3><i class="fas fa-cog"></i> Configuração da Integração</h3>
                <div class="config-group">
                    <label for="api-url">URL do Google Apps Script:</label>
                    <input type="text" id="api-url" class="config-input" placeholder="Cole a URL do seu script aqui">
                </div>
                <div class="btn-group">
                    <button type="button" id="saveConfigBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Configuração
                    </button>
                    <button type="button" id="testConnectionBtn" class="btn btn-secondary">
                        <i class="fas fa-plug"></i> Testar Conexão
                    </button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Submissões Hoje</h3>
                        <p id="today-submissions">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Média Diária</h3>
                        <p id="daily-average">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Operadores Ativos</h3>
                        <p id="active-operators">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Taxa de Resolução</h3>
                        <p id="resolution-rate">0%</p>
                    </div>
                </div>
            </div>
            <div class="content-grid">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clipboard-list"></i>
                        <h2>Formulário de Suporte - Quebras</h2>
                    </div>
                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle"></i> Formulário enviado com sucesso!
                    </div>
                    <form id="suporteForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="operador">1. Nome do Operador: <span>*</span></label>
                                <select id="operador" name="operador" class="form-control" required>
                                    <option value="">Selecione um operador</option>
                                    <option value="Ana Paula Alves Lima">Ana Paula Alves Lima</option>
                                    <option value="Laura Borges Lima">Laura Borges Lima</option>
                                    <option value="Marcio Vinicus">Marcio Vinicus</option>
                                    <option value="Tamara Laura Sousa Soares">Tamara Laura Sousa Soares</option>
                                    <option value="Thayene dos Santos Ferreira">Thayene dos Santos Ferreira</option>
                                    <option value="Kaline Morais dos Santos">Kaline Morais dos Santos</option>
                                    <option value="Felipe Junior">Felipe Junior</option>
                                </select>
                                <p id="operador-error" class="error-message">Por favor, selecione um operador.</p>
                            </div>
                            <div class="form-group">
                                <label for="supervisor">2. Supervisor: <span>*</span></label>
                                <select id="supervisor" name="supervisor" class="form-control" required>
                                    <option value="">Selecione um supervisor</option>
                                    <option value="João Paulo">João Paulo</option>
                                    <option value="Jonathan">Jonathan</option>
                                    <option value="Marcos Vinicius">Marcos Vinicius</option>
                                    <option value="Patrick">Patrick</option>
                                    <option value="Washington">Washington</option>
                                </select>
                                <p id="supervisor-error" class="error-message">Por favor, selecione um supervisor.</p>
                            </div>
                            <div class="form-group">
                                <label for="contrato">3. Contrato do Cliente: <span>*</span></label>
                                <input type="text" id="contrato" name="contrato" class="form-control" placeholder="Digite o contrato do cliente" required>
                                <p id="contrato-error" class="error-message">Por favor, preencha o contrato do cliente.</p>
                            </div>
                            <div class="form-group">
                                <label for="cidade">4. Cidade: <span>*</span></label>
                                <input type="text" id="cidade" name="cidade" class="form-control" placeholder="Digite a cidade" required>
                                <p id="cidade-error" class="error-message">Por favor, preencha a cidade.</p>
                            </div>
                            <div class="form-group">
                                <label for="motivo">5. Motivo das Quebras: <span>*</span></label>
                                <select id="motivo" name="motivo" class="form-control" required>
                                    <option value="">Selecione o motivo</option>
                                    <option value="Ausente">Ausente</option>
                                    <option value="Reagendamento">Reagendamento</option>
                                    <option value="Erro de cadastro/Abertura">Erro de cadastro/Abertura</option>
                                    <option value="Adequação predial">Adequação predial</option>
                                    <option value="Área sem cobertura">Área sem cobertura</option>
                                    <option value="Clean Up">Clean Up</option>
                                    <option value="Cto sem potência">Cto sem potência</option>
                                    <option value="Mudança de endereço - Sem Onu">Mudança de endereço - Sem Onu</option>
                                    <option value="Inviabilidade">Inviabilidade</option>
                                    <option value="Cancelamento">Cancelamento</option>
                                </select>
                                <p id="motivo-error" class="error-message">Por favor, selecione o motivo.</p>
                            </div>
                            <div class="form-group">
                                <label for="contato">6. Foi feito contato com o cliente? <span>*</span></label>
                                <select id="contato" name="contato" class="form-control" required>
                                    <option value="">Selecione uma opção</option>
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                                <p id="contato-error" class="error-message">Por favor, selecione uma opção.</p>
                            </div>
                            <div class="form-group">
                                <label>7. Revertido: <span>*</span></label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="revertido-sim" name="revertido" value="Sim" required>
                                        <label for="revertido-sim">Sim</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="revertido-nao" name="revertido" value="Não">
                                        <label for="revertido-nao">Não</label>
                                    </div>
                                </div>
                                <p id="revertido-error" class="error-message">Por favor, selecione uma opção.</p>
                            </div>
                            <div class="form-group full-width">
                                <label for="observacoes">8. Observações:</label>
                                <textarea id="observacoes" name="observacoes" rows="4" class="form-control" placeholder="Digite suas observações"></textarea>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                            <button type="button" id="exportBtn" class="btn btn-secondary">
                                <i class="fas fa-file-export"></i> Exportar CSV
                            </button>
                            <button type="button" id="syncBtn" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i> Sincronizar Dados
                            </button>
                        </div>
                    </form>
                </div>
                <div>
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i>
                            <h2>Informações Importantes</h2>
                        </div>
                        <div class="info-card">
                            <h3><i class="fas fa-lightbulb"></i> Dicas para Preenchimento</h3>
                            <ul>
                                <li>Verifique sempre o contrato do cliente antes de enviar</li>
                                <li>Informe com detalhes o motivo da quebra</li>
                                <li>Registre observações relevantes para a equipe técnica</li>
                            </ul>
                        </div>
                        <div class="info-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Motivos Mais Comuns</h3>
                            <ul>
                                <li><strong>Ausente (42%)</strong> - Cliente não estava no local</li>
                                <li><strong>Reagendamento (23%)</strong> - Cliente solicitou nova data</li>
                                <li><strong>Área sem cobertura (15%)</strong> - Falta de infraestrutura</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-history"></i>
                            <h2>Últimas Submissões</h2>
                        </div>
                        <div class="search-container">
                            <input type="text" id="searchInput" class="form-control" placeholder="Pesquisar por contrato...">
                            <button id="searchBtn" class="btn btn-secondary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="last-submissions"></div>
                    </div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h2>Acompanhamento Diário</h2>
                    </div>
                    <div class="chart-box">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="card-header">
                        <i class="fas fa-users"></i>
                        <h2>Volume por Operador</h2>
                    </div>
                    <div class="chart-box">
                        <canvas id="operatorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 Suporte Técnico - Gerenciamento de Quebras. Todos os direitos reservados.</p>
        </footer>
    </div>
    
    <script>
        // ID da sua planilha Google Sheets
        const SPREADSHEET_ID = '1g-Bf7qg4ehSZn7w1sXx8TIqovBl0lhpRlRAI1K07w6s';
        const SHEET_NAME = 'REVERSÃO';
        
        // URLs do Google Apps Script
        let API_URL = localStorage.getItem('api_url') || '';
        
        // Elementos DOM
        const form = document.getElementById('suporteForm');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const infoMessage = document.getElementById('info-message');
        const errorText = document.getElementById('error-text');
        const infoText = document.getElementById('info-text');
        const lastSubmissionsContainer = document.getElementById('last-submissions');
        const todaySubmissionsEl = document.getElementById('today-submissions');
        const dailyAverageEl = document.getElementById('daily-average');
        const activeOperatorsEl = document.getElementById('active-operators');
        const resolutionRateEl = document.getElementById('resolution-rate');
        const contentDiv = document.getElementById('content');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const syncBtn = document.getElementById('syncBtn');
        const submitBtn = document.getElementById('submitBtn');
        const lastAccessEl = document.getElementById('last-access');
        const apiUrlInput = document.getElementById('api-url');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        
        // Inicializar variáveis
        let submissions = [];
        let dailyChart, operatorChart;
        let usingLocalStorage = false;
        
        // Configurar o campo de URL
        apiUrlInput.value = API_URL;
        
        // Função para formatar a data
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Função para mostrar/ocultar o loading
        function toggleLoading(show, message = null) {
            if (show) {
                contentDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                if (message) loadingText.textContent = message;
            } else {
                contentDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
            }
        }
        
        // Atualizar o último acesso
        function updateLastAccess() {
            const now = new Date();
            lastAccessEl.textContent = now.toLocaleString('pt-BR');
        }
        
        // Carregar dados da planilha
        async function loadData() {
            try {
                toggleLoading(true, "Conectando com o Google Sheets...");
                errorMessage.style.display = 'none';
                infoMessage.style.display = 'none';
                
                // Verificar se a URL foi configurada
                if (!API_URL || API_URL.trim() === '') {
                    throw new Error('URL do Google Apps Script não configurada');
                }
                
                const response = await fetch(`${API_URL}?action=getData&sheetName=${SHEET_NAME}`);
                
                if (!response.ok) {
                    // Tentar carregar do localStorage se a conexão falhar
                    const localData = localStorage.getItem('submissions');
                    if (localData) {
                        infoText.textContent = 'Usando dados locais (sem conexão com o Google Sheets)';
                        infoMessage.style.display = 'block';
                        submissions = JSON.parse(localData);
                        usingLocalStorage = true;
                        updateUI();
                        return;
                    }
                    throw new Error(`Erro HTTP! status: ${response.status}`);
                }
                
                const data = await response.json();
                submissions = data;
                usingLocalStorage = false;
                
                // Salvar dados localmente como backup
                localStorage.setItem('submissions', JSON.stringify(data));
                
                updateUI();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                
                // Tentar carregar do localStorage
                const localData = localStorage.getItem('submissions');
                if (localData) {
                    infoText.textContent = `Erro ao conectar ao Google Sheets: ${error.message}. Usando dados locais.`;
                    infoMessage.style.display = 'block';
                    submissions = JSON.parse(localData);
                    usingLocalStorage = true;
                    updateUI();
                    return;
                }
                
                errorText.textContent = 'Erro ao carregar dados: ' + error.message;
                errorMessage.style.display = 'block';
            } finally {
                toggleLoading(false);
            }
        }
        
        // Atualizar toda a interface
        function updateUI() {
            updateLastSubmissions();
            updateStats();
            initCharts();
            updateLastAccess();
        }
        
        // Atualizar as últimas submissões com pesquisa
        function updateLastSubmissions() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            let filteredSubmissions = submissions;
            
            if (searchTerm) {
                filteredSubmissions = submissions.filter(sub => 
                    sub.Contrato && sub.Contrato.toLowerCase().includes(searchTerm)
                );
            }
            
            const lastSubs = [...filteredSubmissions].reverse().slice(0, 5);
            let html = '';
            
            lastSubs.forEach(sub => {
                html += `
                <div class="submission-item">
                    <button class="delete-btn" data-id="${sub.Contrato}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div class="submission-header">
                        <div class="submission-id">#${sub.Contrato?.substring(0, 8) || 'N/A'}</div>
                        <div class="submission-date">${formatDate(sub.Data)}</div>
                    </div>
                    <div class="submission-details">
                        Operador: ${sub.Operador || 'N/A'} • Supervisor: ${sub.Supervisor || 'N/A'} • 
                        Motivo: ${sub.Motivo || 'N/A'} • Contato: ${sub.Contato || 'N/A'} • 
                        Revertido: ${sub.Revertido || 'N/A'}
                    </div>
                </div>
                `;
            });
            
            if (lastSubs.length === 0) {
                html = '<p class="no-results">Nenhuma submissão encontrada</p>';
            }
            
            lastSubmissionsContainer.innerHTML = html;
            
            // Adicionar event listeners para os botões de exclusão
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const contrato = this.getAttribute('data-id');
                    deleteSubmission(contrato);
                });
            });
        }
        
        // Atualizar estatísticas
        function updateStats() {
            const today = new Date().toLocaleDateString('pt-BR');
            const todaySubs = submissions.filter(sub => {
                const subDate = new Date(sub.Data).toLocaleDateString('pt-BR');
                return subDate === today;
            });
            todaySubmissionsEl.textContent = todaySubs.length;
            
            const uniqueDays = [...new Set(submissions.map(sub => new Date(sub.Data).toLocaleDateString('pt-BR')))];
            dailyAverageEl.textContent = uniqueDays.length ? Math.round(submissions.length / uniqueDays.length) : 0;
            
            const uniqueOperators = [...new Set(submissions.map(sub => sub.Operador))];
            activeOperatorsEl.textContent = uniqueOperators.length;
            
            const resolved = submissions.filter(sub => sub.Revertido === 'Sim').length;
            resolutionRateEl.textContent = submissions.length ? `${Math.round((resolved / submissions.length) * 100)}%` : '0%';
        }
        
        // Inicializar gráficos
        function initCharts() {
            const dailyData = {};
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                dailyData[dateStr] = 0;
            }
            
            submissions.forEach(sub => {
                const dateStr = new Date(sub.Data).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                if (dailyData[dateStr] !== undefined) dailyData[dateStr]++;
            });
            
            const dailyLabels = Object.keys(dailyData);
            const dailyValues = Object.values(dailyData);
            
            const operatorData = {};
            const operators = [
                "Ana Paula Alves Lima", "Laura Borges Lima", "Marcio Vinicus",
                "Tamara Laura Sousa Soares", "Thayene dos Santos Ferreira",
                "Kaline Morais dos Santos", "Felipe Junior"
            ];
            
            operators.forEach(op => operatorData[op] = 0);
            submissions.forEach(sub => {
                if (operatorData[sub.Operador] !== undefined) operatorData[sub.Operador]++;
            });
            
            const operatorLabels = Object.keys(operatorData);
            const operatorValues = Object.values(operatorData);
            
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            const operatorCtx = document.getElementById('operatorChart').getContext('2d');
            
            if (dailyChart) dailyChart.destroy();
            if (operatorChart) operatorChart.destroy();
            
            dailyChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Submissões Diárias',
                        data: dailyValues,
                        borderColor: '#0f766e',
                        backgroundColor: 'rgba(15, 118, 110, 0.1)',
                        pointBackgroundColor: '#0f766e',
                        pointBorderColor: '#ffffff',
                        pointHoverBackgroundColor: '#14b8a6',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { precision: 0 } },
                        x: { grid: { display: false } }
                    }
                }
            });
            
            operatorChart = new Chart(operatorCtx, {
                type: 'bar',
                data: {
                    labels: operatorLabels,
                    datasets: [{
                        label: 'Volume por Operador',
                        data: operatorValues,
                        backgroundColor: [
                            'rgba(15, 118, 110, 0.7)', 'rgba(20, 184, 166, 0.7)', 'rgba(13, 148, 136, 0.7)',
                            'rgba(8, 145, 178, 0.7)', 'rgba(6, 182, 212, 0.7)', 'rgba(5, 150, 105, 0.7)',
                            'rgba(16, 185, 129, 0.7)'
                        ],
                        borderColor: '#0f766e',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { precision: 0 } },
                        x: { grid: { display: false }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }
        
        // Enviar dados para a planilha
        async function submitForm(data) {
            try {
                // Se estivermos usando localStorage, apenas salve localmente
                if (usingLocalStorage || !API_URL) {
                    submissions.push(data);
                    localStorage.setItem('submissions', JSON.stringify(submissions));
                    return { success: true, message: "Dados salvos localmente" };
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'addSubmission',
                        sheetName: SHEET_NAME,
                        data: data
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao enviar dados para a planilha');
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Erro ao enviar dados:', error);
                throw error;
            }
        }
        
        // Excluir submissão
        async function deleteSubmission(contrato) {
            if (!confirm('Tem certeza que deseja excluir esta submissão?')) {
                return;
            }
            
            try {
                toggleLoading(true, "Excluindo submissão...");
                
                // Encontrar o índice da submissão
                const index = submissions.findIndex(sub => sub.Contrato === contrato);
                
                if (index === -1) {
                    throw new Error('Submissão não encontrada');
                }
                
                // Remover do array
                submissions.splice(index, 1);
                
                // Atualizar localStorage
                localStorage.setItem('submissions', JSON.stringify(submissions));
                
                // Atualizar UI
                updateUI();
                
                infoText.textContent = 'Submissão excluída com sucesso!';
                infoMessage.style.display = 'block';
                setTimeout(() => infoMessage.style.display = 'none', 3000);
            } catch (error) {
                console.error('Erro ao excluir:', error);
                errorText.textContent = 'Erro ao excluir: ' + error.message;
                errorMessage.style.display = 'block';
            } finally {
                toggleLoading(false);
            }
        }
        
        // Evento de envio do formulário
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            infoMessage.style.display = 'none';
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            const operador = document.getElementById('operador').value;
            const supervisor = document.getElementById('supervisor').value;
            const contrato = document.getElementById('contrato').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            const motivo = document.getElementById('motivo').value;
            const contato = document.getElementById('contato').value;
            const revertido = document.querySelector('input[name="revertido"]:checked')?.value;
            const observacoes = document.getElementById('observacoes').value.trim();
            
            let isValid = true;
            if (!operador) {
                document.getElementById('operador-error').style.display = 'block';
                isValid = false;
            }
            if (!supervisor) {
                document.getElementById('supervisor-error').style.display = 'block';
                isValid = false;
            }
            if (!contrato) {
                document.getElementById('contrato-error').style.display = 'block';
                isValid = false;
            }
            if (!cidade) {
                document.getElementById('cidade-error').style.display = 'block';
                isValid = false;
            }
            if (!motivo) {
                document.getElementById('motivo-error').style.display = 'block';
                isValid = false;
            }
            if (!contato) {
                document.getElementById('contato-error').style.display = 'block';
                isValid = false;
            }
            if (!revertido) {
                document.getElementById('revertido-error').style.display = 'block';
                isValid = false;
            }
            
            if (isValid) {
                try {
                    toggleLoading(true, "Enviando dados...");
                    submitBtn.disabled = true;
                    
                    // Formatar os dados
                    const submission = {
                        Data: new Date().toLocaleString('pt-BR'),
                        Operador: operador,
                        Supervisor: supervisor,
                        Contrato: contrato,
                        Cidade: cidade,
                        Motivo: motivo,
                        Contato: contato,
                        Revertido: revertido,
                        Observações: observacoes
                    };
                    
                    // Enviar para a planilha ou salvar localmente
                    await submitForm(submission);
                    
                    // Atualizar dados localmente
                    submissions.push(submission);
                    localStorage.setItem('submissions', JSON.stringify(submissions));
                    
                    successMessage.style.display = 'block';
                    form.reset();
                    updateUI();
                    
                    setTimeout(() => successMessage.style.display = 'none', 3000);
                } catch (error) {
                    console.error('Erro ao enviar formulário:', error);
                    errorText.textContent = 'Erro ao enviar dados: ' + error.message;
                    errorMessage.style.display = 'block';
                } finally {
                    toggleLoading(false);
                    submitBtn.disabled = false;
                }
            }
        });
        
        // Exportar para CSV
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (submissions.length === 0) {
                errorText.textContent = 'Não há dados para exportar!';
                errorMessage.style.display = 'block';
                return;
            }
            
            let csv = 'Data,Operador,Supervisor,Contrato,Cidade,Motivo,Contato,Revertido,Observações\n';
            submissions.forEach(sub => {
                csv += `${sub.Data},${sub.Operador},${sub.Supervisor},${sub.Contrato},${sub.Cidade},${sub.Motivo},${sub.Contato},${sub.Revertido},"${sub.Observações}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'suporte_quebras.csv';
            link.click();
        });
        
        // Botão de sincronizar
        syncBtn.addEventListener('click', function() {
            loadData();
        });
        
        // Salvar configuração
        saveConfigBtn.addEventListener('click', function() {
            const newUrl = apiUrlInput.value.trim();
            if (newUrl) {
                API_URL = newUrl;
                localStorage.setItem('api_url', newUrl);
                infoText.textContent = 'Configuração salva com sucesso!';
                infoMessage.style.display = 'block';
                setTimeout(() => infoMessage.style.display = 'none', 3000);
            } else {
                errorText.textContent = 'Por favor, insira uma URL válida';
                errorMessage.style.display = 'block';
            }
        });
        
        // Testar conexão
        testConnectionBtn.addEventListener('click', async function() {
            const testUrl = apiUrlInput.value.trim();
            if (!testUrl) {
                errorText.textContent = 'Por favor, insira uma URL para testar';
                errorMessage.style.display = 'block';
                return;
            }
            
            try {
                toggleLoading(true, "Testando conexão...");
                
                // Adicionar parâmetros para evitar cache
                const timestamp = new Date().getTime();
                const response = await fetch(`${testUrl}?action=test&t=${timestamp}`);
                
                // Verificar se a resposta é JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error('Resposta não é JSON. Verifique se a URL está correta.');
                }
                
                const result = await response.json();
                if (result.status === "OK") {
                    infoText.textContent = 'Conexão bem-sucedida!';
                    infoMessage.style.display = 'block';
                } else {
                    throw new Error('Resposta inesperada do servidor');
                }
            } catch (error) {
                console.error('Erro ao testar conexão:', error);
                errorText.textContent = 'Erro ao testar conexão: ' + error.message;
                errorMessage.style.display = 'block';
            } finally {
                toggleLoading(false);
            }
        });
        
        // Pesquisar submissões
        searchInput.addEventListener('input', updateLastSubmissions);
        searchBtn.addEventListener('click', updateLastSubmissions);
        
        // Inicializar a página
        function initPage() {
            updateLastAccess();
            
            // Carregar dados locais se existirem
            const localData = localStorage.getItem('submissions');
            if (localData) {
                submissions = JSON.parse(localData);
                updateUI();
            }
            
            // Tentar carregar dados do Google Sheets se a URL estiver configurada
            if (API_URL) {
                loadData();
            }
        }
        
        initPage();
    </script>
</body>
</html>